



<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <base href="http://blog2.snowfrog.net">
    <title> MySQL Replication Notes </title>
    <link rel="canonical" href="http://blog2.snowfrog.net/2007/10/23/mysql-replication-notes/">
    

<link rel="stylesheet" href="http://blog2.snowfrog.net/css/poole.css">

<link rel="stylesheet" href="http://blog2.snowfrog.net/css/lanyon.css">
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

</head>


<body class="theme-base-0b">
  


<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="http://blog2.snowfrog.net/">Home</a>
    <a class="sidebar-nav-item" href="http://blog2.snowfrog.net/posts">Posts by Date</a>
    <a class="sidebar-nav-item" href="http://blog2.snowfrog.net/categories">Posts by Category</a>
    <a class="sidebar-nav-item" href="http://blog2.snowfrog.net/tags">Posts by Tag</a>
  </nav>

  <div class="sidebar-item">
    <p>
      My name is Sonia Hamilton, I live in <a
        href="http://en.wikipedia.org/wiki/Sydney">Sydney Australia</a>. I work
      in IT and previously I've been at companies like Optus, News Digital and
      Google.
    </p>
    <p>
      I'm interested in all things <a
        href="http://en.wikipedia.org/wiki/Linux">Linux</a> and <a
        href="http://en.wikipedia.org/wiki/Open_source">Open Source</a>, and I
      also enjoy martial arts - <a
        href="http://en.wikipedia.org/wiki/Balintawak_Eskrima">Balintawak
        Arnis</a> (Filipino stick fighting) and <a
        href="http://en.wikipedia.org/wiki/Bjj">BJJ</a> (Brazilian Jiu Jitsu).
      After all that training, I do <a
        href="http://www.baronbaptiste.com/">Vinyasa Yoga</a> to stretch out
      and relax.
    </p>
    <p>
      Email me at <a
        href="mailto:sonia@snowfrog.net">sonia@snowfrog.net</a>; find me on <a
        href="http://au.linkedin.com/in/soniahamilton">LinkedIn</a>; follow me
      on <a href="http://twitter.com/sonia_hamilton">Twitter</a>; fork my <a
      href="https://github.com/soniah">Github</a> code; see my questions on <a
      href="http://stackoverflow.com/users/658270/sonia-hamilton">Stack
      Overflow</a>; watch my <a
      href="http://www.youtube.com/user/savannacat">Youtube Videos</a>.
    </p>
    <p>
      &copy; 2005-2015 Sonia Hamilton, <a
        href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.
      Powered by <a href="http://hugo.spf13.com">Hugo</a>.
    </p>
  </div>
</div>


  
  <div class="wrap">
    <div class="masthead">
      <div class="container">
        <h3 class="masthead-title">
          <a href="http://blog2.snowfrog.net/" title="Sonia Hamilton - Blog">Sonia Hamilton - Blog</a>
        </h3>
      </div>
    </div>

    
    <div class="container content">
      <h1 class="post-title">MySQL Replication Notes</h1>
        <section id="main">
          <h5 id="date"> 23 Oct 2007 </h5>
          

<p>dev.mysql.com <a href="http://dev.mysql.com/doc/refman/5.0/en/replication.html">replication documentation</a>. Replication on MySQL is similar to <em>Log Shipping</em> on MS SQL; the default is <em>statement level</em> replication, but newer versions also offer <em>row-based</em> replication.</p>

<p>See also:</p>

<p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-master-slave-replication-in-mysql">https://www.digitalocean.com/community/tutorials/how-to-set-up-master-slave-replication-in-mysql</a></p>

<p><strong>Setting Up</strong></p>

<p>On the Master:</p>

<ul>
<li><p>create the account that will be used by each slave for replication:
<pre class="brush: bash; title: ; notranslate" title="">&gt; create user &lsquo;repl&rsquo;@&lsquo;%&rsquo; identified by &lsquo;secret&rsquo;;
&gt; grant replication slave on <em>.</em> to &lsquo;repl&rsquo;@&lsquo;%&rsquo;;
&gt; flush privileges;
</pre></p></li>

<li><p>enable for replication by editing modify <strong>/etc/my.cnf</strong> (fuller example below):</p></li>
</ul>

<pre class="brush: bash; title: ; notranslate" title="">[mysqld]
server-id=1               # number needs to be unique amongst all servers - can be any number
log-bin=mysql-bin         # can be left empty, but convention is to call mysql-bin
binlog-ignore-db=mysql    # any databases not to replicate
# if using any InnoDB tables, for the greatest possible durability and consistency set:
innodb_flush_log_at_trx_commit=1
sync_binlog=1
.
$ /etc/init.d/mysql restart
</pre>

<ul>
<li><p>stop updates, record the log file name and position, copy data:
<pre class="brush: bash; title: ; notranslate" title="">mysql&gt; flush tables with read lock;
mysql&gt; show master statusG</p>

<h1 id="the-following-step-must-be-done-in-another-terminal:3a267fae710283cba380e6ea7b085197">the following step <em>must</em> be done in another terminal:</h1>

<p>$ mysqlhotcopy &ndash;method=scp &ndash;user=root &ndash;password=secret database root@dest_host:/var/lib/mysql
mysql&gt; unlock tables; # release locks in the original terminal
</pre></p></li>

<li><p>other methods of copying data:</p>

<ul>
<li>if only using MyISAM the <strong>LOAD DATA FROM MASTER</strong> command can be used <em>without having to stop the master</em>; even though it&rsquo;s usage is <a href="http://dev.mysql.com/doc/refman/5.0/en/load-data-from-master.html">deprecated</a> there&rsquo;s no equivalent replacement. Additional permissions have to be assigned to the slave repl account (xx) and some network settings need to be temporarily changed (??), and a global read lock needs to be held on the master (thus preventing updates while transferring data)</li>
<li>data can also be copied using <a href="http://dev.mysql.com/doc/refman/5.0/en/replication-howto-mysqldump.html">mysqldump</a> or by <a href="http://dev.mysql.com/doc/refman/5.0/en/replication-howto-rawdata.html">dumping the raw files</a>. If using InnoDB there&rsquo;s <a href="http://dev.mysql.com/doc/refman/5.0/en/replication-howto-rawdata.html">also</a> a commercial product called <a href="http://www.innodb.com/hot-backup">Hot Backup</a>.</li>
</ul></li>

<li><p>if using different storage engines between the master and slave, don&rsquo;t put the engine statements in the CREATE or ALTER TABLE statements (as they&rsquo;ll be replicated). Either use SET storage_engine followed by CREATE TABLE, or stop the slave and issue ALTER TABLE statements on the slave; see <a href="http://dev.mysql.com/doc/refman/5.0/en/replication-solutions-diffengines.html">documentation</a>.</p></li>

<li><p>Binary log files must be removed when they&rsquo;re no longer needed because MySQL doesn&rsquo;t do so automatically. Use <strong>purge master logs to &lsquo;mysql-bin.1234&rsquo;;</strong> O&rsquo;Reilly&rsquo;s <em>High Performance MySQL</em> has a log purge script (section 7.5), as well as other useful scripts for managing replication</p></li>
</ul>

<p>On the Slave:</p>

<ul>
<li>enable for replication by editing modify <strong>/etc/my.cnf</strong> &ndash; only need to set a unique <em>server-id</em>, unless this slave will also act as a master for other slaves</li>
<li>restart mysql, check that data copied ok with <em>mysqlhotcopy</em> by doing a <em>show tables;</em> (etc.) in the new database</li>
<li>start replication:
<pre class="brush: bash; title: ; notranslate" title="">mysql&gt; change master to master host = &lsquo;master host&rsquo;, master user = &lsquo;repl&rsquo;, master_password = &lsquo;secret&rsquo;, master_log_file = &lsquo;master_log_file&rsquo;, master_log_pos = &lsquo;master_log_pos&rsquo;;
mysql&gt; start slave;
</pre></li>
</ul>

<p>Note: this information is stored in the file data_dir/master.info, so the password isn&rsquo;t very secure</p>

<ul>
<li>to <em>quickly</em> add <em>another slave</em>, see <a href="http://dev.mysql.com/doc/refman/5.0/en/replication-howto-additionalslaves.html">this topic</a> (shutdown an existing slave, copy the data directory with logs and info files, set a unique server-id, start existing and new slave)</li>
</ul>

<p><strong>Master .my.cnf</strong> should look like:</p>

<pre class="brush: bash; title: ; notranslate" title="">[mysqld]
server-id = 71
log-bin=mysql-bin # use a standard name
relay-log=relay-bin # use a standard name
log=/var/log/mysql/mysql.log # general logging
log-slow-queries=/var/log/mysql/mysql-slow.log # log slow queries
log-error=/var/log/mysql/mysql-error.log # log errors
binlog-ignore-db=mysql # as master, don't send this to my slaves
log-slave-updates # this master is also a slave
replicate-do-db=foodb # as slave, only pull this db from *my* master
</pre>

<p><strong>Slave .my.cnf</strong> should look like:</p>

<pre class="brush: bash; title: ; notranslate" title="">[mysqld]
server-id=72
log-bin=mysql-bin # use a standard name
relay-log=relay-bin # use a standard name
log=/var/log/mysql/mysql.log # general logging
log-slow-queries=/var/log/mysql/mysql-slow.log # log slow queries
log-error=/var/log/mysql/mysql-error.log # log errors
</pre>

<p>**Monitoring/Troubleshooting **</p>

<p>See <a href="http://dev.mysql.com/doc/refman/5.0/en/replication-problems.html">Troubleshooting Replication</a>.</p>

<p>On the Master:</p>

<ul>
<li><strong>show master statusG</strong> &ndash; shows the binary log file name and position. O&rsquo;Reilly&rsquo;s <em>High Performance MySQL</em> has a heartbeat script (section 7.5)</li>
<li><strong>show processlistG</strong> &ndash; the master uses one thread to provide replication to slaves (<strong>Command: Binlog Dump</strong>). No <strong>state</strong> means replication hasn&rsquo;t been setup correctly. Good <strong>states</strong> are <em>Sending binlog event to slave, Finished reading one binlog; switching to next binlog, Has sent all binlog to slave; waiting for binlog to be updated</em>.</li>
<li><strong>show master logsG</strong> &ndash; shows names of existing binary log files</li>
<li><strong>$ mysqlbinlog mysql-bin.1234</strong> &ndash; allows you to read through binary and relay logs on both Master and Slave. Has the standard -u -h -p options, as well as -o to specify offset to start at</li>
</ul>

<p>On the Slave:</p>

<ul>
<li><strong>show slave statusG</strong> (<a href="http://dev.mysql.com/doc/refman/5.0/en/show-slave-status.html">documentation</a>) &ndash; key things to watch for are:

<ul>
<li><em>Seconds_Behind_Master</em> should be close to zero</li>
<li><em>Slave_IO_Running</em> and <em>Slave_SQL_Running</em> should both be &lsquo;Yes&rsquo;</li>
<li><em>Read_Master_Log_Pos</em> should only be slightly behind the position given by <em>show master status</em> on the master.</li>
<li><em>Exec_Master_Log_Pos</em> should only be slightly behind <em>Read_Master_Log_Pos</em></li>
<li>watch <em>Last_Errno</em> and <em>Last_Error</em> for errors and all the <em>Replicate/Ignore DB/Table</em> fields for data not being replicated. In an emergency, troublesome statements can be skipped over using TODO.</li>
</ul></li>
<li><strong>show process listG</strong> &ndash; the slave uses two threads to implement replication &ndash; the <em>I/O thread</em> reads events from the master and stores them in the relay log; and the <em>SQL</em> thread reads statements from the relay log and applies them. A good state for the I/O thread is <em>Waiting for master to send event</em>; see doco for many other states. Good states for the SQL thread are <em>Reading event from the relay log; and Has read all relay log; waiting for the slave I/O thread to update it</em></li>
<li><strong>start slave;</strong> see <a href="http://dev.mysql.com/doc/refman/5.0/en/start-slave.html">documentation</a>.</li>
<li><strong>stop slave;</strong> or even better <strong>stop slave sql_thread;</strong> Statements continue to be read and written to relay log, but they aren&rsquo;t applied, allowing a backup of the slave to be done then allowing the slave to catch more rapidly when restarted &ndash; see <a href="http://dev.mysql.com/doc/refman/5.0/en/replication-administration-pausing.html">documentation</a>.</li>
<li>to prevent replication automatically occurring on a restart, start up server with <em>&ndash;skip-slave-start</em> to skip the saved .info files (or delete those files beforehand to wipe replication completely).</li>
</ul>

<p>See Also:</p>

<ul>
<li><a href="http://www.howtoforge.com/mysql5_master_master_replication_debian_etch">How-To Forge Master-Master Replication</a></li>
<li><a href="http://www.howtoforge.com/back_up_mysql_dbs_without_interruptions">How-To Forge Backups w/o Service Interuption (Replication)</a></li>
</ul>

        </section>

    </div>
  </div>

  <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  

<div class="container">
  <hr />
  
    <span class="left">
    &nbsp; <em>&laquo; Previous:</em> <a class="next" href="http://blog2.snowfrog.net/2007/10/24/good-copy-bad-copy/">Good Copy Bad Copy</a>
    </span>
  

  
    <span class="right">
    <em>Next: </em><a class="next" href="http://blog2.snowfrog.net/2007/10/22/linux-acls/"> &nbsp; Linux ACLs</a> &raquo;
    </span>
  
  <br />
</div>

  <br />
  
<div class="container">
  <ul class="catlist">
    <li><em>Categories: </em></li>
    
      <li><a href="http://blog2.snowfrog.net/categories/other-tech">Other-Tech</a> </li>
    
  </ul>
</div>

  <br />
  
<div class="container">
  <ul class="catlist">
    <li><em>Tags: </em></li>
    
      <li><a href="http://blog2.snowfrog.net/tags/mysql">MySQL</a> </li>
    
  </ul>
</div>



  
  

<div class="container content">
<footer>
  <div>
    <p class="right credit">
    <a href="http://blog2.snowfrog.net/">Home</a>&nbsp;&nbsp;
    <a href="http://blog2.snowfrog.net/posts">Posts by Date</a>&nbsp;&nbsp;
    <a href="http://blog2.snowfrog.net/categories">Posts by Category</a>&nbsp;&nbsp;
    <a href="http://blog2.snowfrog.net/tags">Posts by Tag</a>&nbsp;&nbsp;
    <a href="http://blog2.snowfrog.net/privacy">Privacy</a>&nbsp;&nbsp;
    </p>
  </div>
</footer>
</div>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  
  
  

</script>


</body>
</html>




