



<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <base href="http://blog2.snowfrog.net">
    <title> git bisect run - example </title>
    <link rel="canonical" href="http://blog2.snowfrog.net/2013/03/14/git-bisect-run-example/">
    

<link rel="stylesheet" href="http://blog2.snowfrog.net/css/poole.css">

<link rel="stylesheet" href="http://blog2.snowfrog.net/css/lanyon.css">
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

</head>


<body class="theme-base-0b">
  


<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="http://blog2.snowfrog.net/">Home</a>
    <a class="sidebar-nav-item" href="http://blog2.snowfrog.net/posts">Posts by Date</a>
    <a class="sidebar-nav-item" href="http://blog2.snowfrog.net/categories">Posts by Category</a>
    <a class="sidebar-nav-item" href="http://blog2.snowfrog.net/tags">Posts by Tag</a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015 Sonia Hamilton. Powered by <a href="http://hugo.spf13.com">Hugo</a>. Design adapted from <a href="http://lanyon.getpoole.com">Lanyon</a>.
    </p>
  </div>
</div>


  
  <div class="wrap">
    <div class="masthead">
      <div class="container">
        <h3 class="masthead-title">
          <a href="http://blog2.snowfrog.net/" title="Sonia Hamilton - Blog">Sonia Hamilton - Blog</a>
        </h3>
      </div>
    </div>

    
    <div class="container content">
      <h1 class="post-title">git bisect run - example</h1>
        <section id="main">
          <h5 id="date"> 14 Mar 2013 </h5>
          

<p><a href="http://www.kernel.org/pub/software/scm/git/docs/git-bisect.html">Git bisect</a> is a great tool for finding bugs in a program. But many examples show manual uses of git bisect - here&rsquo;s an example of automating the process using <strong>git bisect run</strong>.</p>

<h2 id="tl-dr:1dca976519824c917954d37e9d104a12">tl;dr</h2>

<p>Using <strong>git bisect run</strong> is easy if you&rsquo;ve make small atomic commits and you have good tests. <strong>run</strong> makes a large debug easier (compared to manually doing <strong>git bisect good</strong> and <strong>git bisect bad</strong>) - you&rsquo;re less likely to make errors due to boredom. And run means you can use an iterative process - use rebase to split bad commits then just run again.</p>

<h2 id="example:1dca976519824c917954d37e9d104a12">Example</h2>

<p>So I had an elusive bug in a long running process (an snmp poller, calculator and aggregator for a large network). I had a point where the program was <strong>good</strong>, but I&rsquo;d added more features since good and now results were <strong>bad</strong>. The first step was to write a shell script to be called from <strong>git bisect run</strong>:</p>

<p><div class="highlight" style="background: #202020"><pre style="line-height: 125%">% cat bisect.sh
<span style="color: #999999; font-style: italic">#!/bin/bash</span>
<span style="color: #999999; font-style: italic"># copy this to ~ before running with `git bisect run ~/bisect.sh`</span>

cp ~/Makefile .
make clean

<span style="color: #999999; font-style: italic"># make modifies manpage output, so stash after build</span>
<span style="color: #6ab825; font-weight: bold">if</span> make <span style="color: #d0d0d0">&amp;</span>&gt; /dev/null <span style="color: #d0d0d0">;</span> <span style="color: #6ab825; font-weight: bold">then</span>
	git stash
	git stash clear
<span style="color: #6ab825; font-weight: bold">else</span>
	git stash
	git stash clear
	<span style="color: #24909d">exit </span>125
<span style="color: #6ab825; font-weight: bold">fi</span>

sudo cat /var/tmp/empty &gt; /var/log/abc/abc-poller.log
sudo ./abc-poller --tmp --once -d <span style="color: #3677a9">2</span> -c <span style="color: #3677a9">150</span> <span style="color: #d0d0d0">||</span> <span style="color: #24909d">exit </span>125
<span style="color: #24909d">echo</span> <span style="color: #ed9d13">&quot;=== poller finished&quot;</span>

<span style="color: #40ffff">percent</span><span style="color: #d0d0d0">=</span><span style="color: #ed9d13">`</span><span style="color: #40ffff">godir</span><span style="color: #d0d0d0">=</span>/var/tmp/data/abcmon/poll_queue/new ~/checker <span style="color: #d0d0d0">|</span> <span style="color: #ed9d13">\</span>
  tail -1 <span style="color: #d0d0d0">|</span> awk <span style="color: #ed9d13">&#39;{print $5}&#39;</span> <span style="color: #d0d0d0">|</span> awk -F. <span style="color: #ed9d13">&#39;{print $1}&#39;`</span>
<span style="color: #24909d">echo</span> <span style="color: #ed9d13">&quot;=== percent is </span><span style="color: #40ffff">$percent</span><span style="color: #ed9d13">&quot;</span>
<span style="color: #d0d0d0">((</span> percent &lt; <span style="color: #3677a9">5</span> <span style="color: #d0d0d0">))</span>
</pre></div>
</p>

<p>Things that make writing the test script easier:</p>

<ul>
<li><p>first get it working outside of <strong>git bisect run</strong> - usually means echoing results along the way</p></li>

<li><p>already having a test suite that produces a quantified pass/fail output, In my case the I had already written the checker program, whose last line of output contained a &ldquo;percentage failure&rdquo; figure</p></li>
</ul>

<p>Next step was having an abbreviated log of commits to refer to:</p>

<p><div class="highlight" style="background: #202020"><pre style="line-height: 125%">% git log --oneline
f00f232 sql.go - better debugging       <span style="color: #999999; font-style: italic"># bad                                                                                                                                                        </span>
9780d44 dummy .gitignore, so out dir preserved
0de0796 Makefile <span style="color: #6ab825; font-weight: bold">for</span> nsch1abcs01
a2f6c96 defaults - <span style="color: #3677a9">20</span> workers, udp 15
b8ee3d9 GOMAXPROCS<span style="color: #d0d0d0">()</span>
04f21ba start v0.0.2
dbc6a60 Makefile: Jenkins as default <span style="color: #6ab825; font-weight: bold">for</span> env vars
557a5e3 more work on stats
ef6a453 remove excessive debugging
ccc4644 remove file buffering - wasn<span style="color: #ed9d13">&#39;t writing..???</span>
<span style="color: #ed9d13">98bf4b1 stats write failing</span>
<span style="color: #ed9d13">9a9682d move type queue_t struct</span>
<span style="color: #ed9d13">467aeed buffered writes for queue file</span>
<span style="color: #ed9d13">148a8cc stats: + device_run, device_ok</span>
<span style="color: #ed9d13">c61be42 done chan *Stats_t; calculate_value() bool</span>
<span style="color: #ed9d13">0e41461 debugging - print out device_id as %5s</span>
<span style="color: #ed9d13">7cbe167 default workers 5000, correct stop/start commands</span>
<span style="color: #ed9d13">544e8d7 gather statistics</span>
<span style="color: #ed9d13">6990cf2 rename data chan to device_id</span>
<span style="color: #ed9d13">5e8562b rename sql -&gt; sqlconn; global var</span>
<span style="color: #ed9d13">fd52d89 remove dead code</span>
<span style="color: #ed9d13">4d7b9b1 device_for() - err if count != 1</span>
<span style="color: #ed9d13">6ceb305 deb: fail if version main.go isn&#39;</span>t same changelog
5ce1855 deb: rules producing abc-poller_0.0.1_amd64.deb
db5bff4 deb: cleaned up Makefile, roffs
76674c2 JSON -&gt; SQL<span style="color: #d0d0d0">;</span> version 0.0.1
4cf198e deb: basic removal of <span style="color: #3677a9">64</span> references
d980f26 deb: rename <span style="color: #3677a9">64</span> to vanilla
b933570 deb: remove <span style="color: #3677a9">32</span> bit stuff
970bd82 current debug level is 2<span style="color: #d0d0d0">;</span> adjust output
70f8921 Revert <span style="color: #ed9d13">&quot;deb build - don&#39;t init, cron while testing&quot;</span>
855ce00 default debug is 2<span style="color: #d0d0d0">;</span> misc tidy
f3d80e1 remove timeoutOpt - no longer used
48ced38 misc tidys before release
a3fe13c runonceOpt, revert cycling code  <span style="color: #999999; font-style: italic"># good</span>
24cd998 use passed in udpOpt
5ca1830 remove stash/sender.old.go
06b9566 remove gsnmpgo<span style="color: #d0d0d0">;</span> use gosnmp
bffd430 rules: add note about <span style="color: #ed9d13">&quot;too many open files&quot;</span>
</pre></div>
</p>

<p>Mark bad and good, start the run, go and have a coffee :-)</p>

<p><div class="highlight" style="background: #202020"><pre style="line-height: 125%">% git bisect start f00f232 a3fe13c
% git bisect run ~/bisect.sh
<span style="color: #999999; font-style: italic"># lots of output</span>
</pre></div>
</p>

<p>I get the result that the ominously named <strong>557a5e3 more work on stats</strong> is the first bad commit - I remember it as one of those large &ldquo;kitchen sink&rdquo; commits done at the end of the day. So &ldquo;first rule of fightclub git&rdquo; remembered - <strong>always do small atomic commits</strong>.</p>

<p>I have a useful shell function <strong>gri()</strong> - I used that to interactively rebase and break up 557a5e3 into many small commits:</p>

<p><div class="highlight" style="background: #202020"><pre style="line-height: 125%">gri <span style="color: #d0d0d0">()</span> <span style="color: #d0d0d0">{</span>
  git rebase -i HEAD~<span style="color: #ed9d13">${</span><span style="color: #40ffff">1</span><span style="color: #6ab825; font-weight: bold">:-</span><span style="color: #40ffff">7</span><span style="color: #ed9d13">}</span>
<span style="color: #d0d0d0">}</span>
</pre></div>
</p>

<p>After rebasing git log looked like this - notice the many small commits named &ldquo;bisect1&rdquo; etc:</p>

<p><div class="highlight" style="background: #202020"><pre style="line-height: 125%">382b3ee defaults - <span style="color: #3677a9">20</span> workers, udp 15
11db314 GOMAXPROCS<span style="color: #d0d0d0">()</span>
4b547ea start v0.0.2
c92feef Makefile: Jenkins as default <span style="color: #6ab825; font-weight: bold">for</span> env vars
8fcc595 bisect6: calc/noncalc
ad3a18f bisect5: tweak debug msgs
311bb8d bisect4: mv stats init
957c234 bisect3: remove stats from send_gosnmp<span style="color: #d0d0d0">()</span>
3c01d62 bisect2: use Add<span style="color: #d0d0d0">();</span> Calcs/NonCalcs
947cb27 bisect1: move Stats_t<span style="color: #d0d0d0">;</span> Add<span style="color: #d0d0d0">()</span>
ef6a453 remove excessive debugging
ccc4644 remove file buffering - wasn<span style="color: #a61717; background-color: #e3d2d2">&#39;</span>t writing..???
98bf4b1 stats write failing
</pre></div>
</p>

<p>And here&rsquo;s the real win of writing bisect.sh - you can just keep rebasing and running until you&rsquo;ve narrowed down the bad code to a few lines:</p>

<p><div class="highlight" style="background: #202020"><pre style="line-height: 125%"><span style="color: #d0d0d0">===</span> poller <span style="color: #40ffff">finished</span>
<span style="color: #d0d0d0">===</span> percent is 49
947cb27fd57642dc545ee23090d7ae8fd8b14b3f is the first bad commit
commit 947cb27fd57642dc545ee23090d7ae8fd8b14b3f
Author: Sonia Hamilton &lt;sonia@snowfrog.net&gt;
Date:   Thu Mar <span style="color: #3677a9">14</span> 10:02:42 <span style="color: #3677a9">2013</span> +1100

    bisect1: move Stats_t<span style="color: #d0d0d0">;</span> Add<span style="color: #d0d0d0">()</span>
</pre></div>
</p>

<p>I do another interactive rebase, fix the logic error, and then HEAD is good.</p>

        </section>

    </div>
  </div>

  <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  

<div class="container">
  <hr />
  
    <span class="left">
    &nbsp; <em>&laquo; Previous:</em> <a class="next" href="http://blog2.snowfrog.net/2013/06/03/ubuntu-howto-recover-encrypted-home-directory/">Ubuntu - HowTo Recover Encrypted Home Directory</a>
    </span>
  

  
    <span class="right">
    <em>Next: </em><a class="next" href="http://blog2.snowfrog.net/2013/03/11/gosnmp-snmp-for-golang/"> &nbsp; GoSnmp - SNMP for GoLang</a> &raquo;
    </span>
  
  <br />
</div>

  <br />
  
<div class="container">
  <ul class="catlist">
    <li><em>Categories: </em></li>
    
      <li><a href="http://blog2.snowfrog.net/categories/linux">Linux</a> </li>
    
  </ul>
</div>

  <br />
  
<div class="container">
  <ul class="catlist">
    <li><em>Tags: </em></li>
    
      <li><a href="http://blog2.snowfrog.net/tags/git">Git</a> </li>
    
      <li><a href="http://blog2.snowfrog.net/tags/golang">Golang</a> </li>
    
  </ul>
</div>



  
  

<div class="container content">
<footer>
  <div>
    <p class="right credit">
    <a href="http://blog2.snowfrog.net/">Home</a>&nbsp;&nbsp;
    <a href="http://blog2.snowfrog.net/posts">Posts by Date</a>&nbsp;&nbsp;
    <a href="http://blog2.snowfrog.net/categories">Posts by Category</a>&nbsp;&nbsp;
    <a href="http://blog2.snowfrog.net/tags">Posts by Tag</a>&nbsp;&nbsp;
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">License</a>
    </p>
  </div>
</footer>
</div>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  
  
  

</script>


</body>
</html>




